<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPP Provider Details</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .provider-container {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
        }

        .item-container {
            border: 1px solid #eee;
            padding: 10px;
            margin-top: 10px;
        }

        .item-quantity {
            display: flex;
            align-items: center;
        }

        .quantity-btn {
            cursor: pointer;
            margin: 0 5px;
        }

        /* Cart styles and modal */
        #cartContainer {
            position: fixed;
            top: 10px;
            right: 10px;
        }

        #cartIcon {
            cursor: pointer;
        }

        #cartModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
</head>

<body>
    <h1>BPP Provider Details</h1>

    <button onclick="closePageAndOpenWhatsApp()">Close and Open WhatsApp</button>

    <!-- Display BPP provider information -->
    <div class="provider-container">
        <h2>BPP Provider Information</h2>
        <% if (matchingData && matchingData.message && matchingData.message.catalog && matchingData.message.catalog["bpp/descriptor"]) { %>
            <p>Name: <%= matchingData.message.catalog["bpp/descriptor"].name %></p>
            <p>Description: <%= matchingData.message.catalog["bpp/descriptor"].short_desc %></p>
            <img src="<%= matchingData.message.catalog["bpp/descriptor"].symbol %>" alt="BPP Provider Image"
                style="max-width: 200px; max-height: 200px;">
        <% } else { %>
            <p>No BPP Provider Information available</p>
        <% } %>
    </div>

    <!-- Display BPP provider items details -->
    <div id="itemsContainer">
        <% if (matchingData && matchingData.message && matchingData.message.catalog && matchingData.message.catalog["bpp/providers"]) { %>
            <% const firstProvider = matchingData.message.catalog["bpp/providers"][0]; %>
            <% firstProvider.items.forEach((item, index) => { %>
                <div class="provider-container">
                    <h2>Provider: <%= firstProvider.descriptor.name %></h2>
                    <p>Description: <%= firstProvider.descriptor.short_desc %></p>
                    <img src="<%= firstProvider.descriptor.symbol %>" alt="Provider Image"
                        style="max-width: 150px; max-height: 150px;">

                    <!-- Display items for each provider -->
                    <div class="item-container">
                        <p>Item Name: <%= item.descriptor.name %></p>
                        <p>Description: <%= item.descriptor.short_desc %></p>
                        <img src="<%= item.descriptor.symbol %>" alt="Item Image"
                            style="max-width: 100px; max-height: 100px;">

                        <!-- Quantity and Add to Cart functionality -->
                        <div class="item-quantity">
                            <button class="quantity-btn" onclick="decrementQuantity('<%= index %>')">-</button>
                            <span id="quantity<%= index %>">1</span>
                            <button class="quantity-btn" onclick="incrementQuantity('<%= index %>')">+</button>
                            <button onclick="addToCart('<%= item.descriptor.name %>', '<%= item.id %>', '<%= index %>')">Add to Cart</button>
                        </div>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <p>No BPP Providers available</p>
        <% } %>
    </div>

    <!-- Cart icon and total quantities -->
    <div id="cartContainer">
        <span id="cartIcon" onclick="showCartDetails()">ðŸ›’</span>
        <span id="totalQuantities">0</span>
    </div>

    <!-- Cart modal and overlay -->
    <div id="overlay"></div>
    <div id="cartModal">
        <h2>Cart Details</h2>
        <div id="cartItems"></div>
        <button onclick="closeCartModal()">Confirm and Close</button>
    </div>

    <% if (matchingData && matchingData.message && matchingData.message.catalog && matchingData.message.catalog["bpp/providers"]) { %>
        <script>
            const itemQuantities = Array.from({ length: '<%= matchingData.message.catalog["bpp/providers"][0].items.length || 0 %>'}, () => 1);
            var totalQuantity = 0;

            const cartItems = [];

            function incrementQuantity(index) {
                itemQuantities[index]++;
                const element = document.getElementById(`quantity${index}`);
                if (element) {
                    element.textContent = itemQuantities[index].toString();
                     
                }
                //updateQuantityDisplay();
            }

            function decrementQuantity(index) {
                if (itemQuantities[index] > 1) {
                    itemQuantities[index]--;
                    const element = document.getElementById(`quantity${index}`);
                    if (element) {
                        element.textContent = itemQuantities[index].toString();
                    }
                    //updateQuantityDisplay();
                }
            }

            function updateQuantityDisplay(index) {
                const totalQuantitiesElement = document.getElementById('totalQuantities');
                if (totalQuantitiesElement) {
                    totalQuantity +=  itemQuantities[index];
                    totalQuantitiesElement.textContent = totalQuantity.toString();
                }
            }

            function addToCart(itemName, itemId, index) {
                updateQuantityDisplay(index);

                const existingItemIndex = cartItems.findIndex(item => item.itemId === itemId);

                if (existingItemIndex !== -1) {
                    // If the item exists, update its quantity
                    cartItems[existingItemIndex].quantity += itemQuantities[index];
                } else {
                    // If the item doesn't exist, add it to the cartItems array
                    cartItems.push({
                        itemId: itemId,
                        quantity: itemQuantities[index],
                        itemName: itemName
                    });
                }

                const cartItemsContainer = document.getElementById('cartItems');
                if (cartItemsContainer) {
                    cartItemsContainer.innerHTML = '';
                    cartItems.forEach(item => {
                        cartItemsContainer.innerHTML += `<p>${item.quantity} x ${item.itemName}</p>`;
                    });
                }
            }

            function showCartDetails() {
                const cartModal = document.getElementById('cartModal');
                const overlay = document.getElementById('overlay');

                // Show the cart modal and overlay
                cartModal.style.display = 'block';
                overlay.style.display = 'block';
            }

            function closeCartModal() {
                const cartModal = document.getElementById('cartModal');
                const overlay = document.getElementById('overlay');

                const updatedItemList = [];

                // Iterate through the cartItems array
                cartItems.forEach(item => {
                    // Add the item details to the updatedItemList array
                    updatedItemList.push({
                        id: item.itemId,
                        quantity: {
                            count: item.quantity
                        }
                    });
                });

                var body = {
                    "context": {
                    "domain": "nic2004:52110",
                    "country": "IND",
                    "city": "*",
                    "action": "select",
                    "core_version": "1.1.0",
                    "bap_id": '<%= matchingData.context.bap_id%>',
                    "bap_uri": '<%= matchingData.context.bap_uri%>',
                    "transaction_id": "252cc06b-3a38-4b70-bbf7-985650ea1c0e",
                    "message_id": '<%= matchingData.context.message_id%>',
                    "timestamp": "",
                    "ttl": "P1M",
                    "bpp_id": '<%= matchingData.context.bpp_id%>',
                    "bpp_uri": '<%= matchingData.context.bpp_uri%>',
                    },
                    "message": {
                        "order": {
                            "items": updatedItemList,
                            "provider": {
                                "id": '<%= matchingData.message.catalog["bpp/providers"][0].id%>',
                                "locations": [
                                    {
                                        "id": '<%= matchingData.message.catalog["bpp/providers"][0].locations[0].id%>',
                                    }
                                ]
                            }, 
                            "fulfillments": [
                                {
                                    "end": {
                                        "location": {
                                        //"gps": "18.5529805,73.9482617",
                                        "address": {
                                                "area_code": '<%= matchingData.message.catalog["bpp/providers"][0].locations[0].address.area_code%>',
                                            }
                                        }
                                    }
                                }
                            ]
                        },
                    },
                };

                alert(JSON.stringify(body)); 

                // Hide the cart modal and overlay
                cartModal.style.display = 'none';
                overlay.style.display = 'none';
            }

            function closePageAndOpenWhatsApp() {
                window.close();
                if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                    window.open('https://wa.me/9113951221', '_blank');
                } else {
                    // Open WhatsApp Web on desktop
                    window.open('https://web.whatsapp.com/', '_blank');
                }
            }
        </script>
    <% } %>
</body>

</html>
